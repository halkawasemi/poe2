<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoE2 Build Simulator v3.0 - Gear Integration</title>
    <style>
        :root {
            --bg-color: #0b0b0b;
            --panel-bg: #141414;
            --input-bg: #000;
            --card-bg: #1a1a1a;
            --text-main: #dcdcdc;
            --text-muted: #888;
            --text-value: #fff;
            --accent-gold: #c8aa6d;
            --accent-fire: #b7362a;
            --accent-ice: #3a7caf;
            --accent-lightning: #d4b924;
            --accent-pos: #4ece70;
            --accent-neg: #d14e4e;
            --border-color: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        h1 { color: var(--accent-gold); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; }
        .version-tag { font-size: 0.8rem; color: #555; margin-bottom: 25px; border: 1px solid #333; padding: 2px 8px; border-radius: 4px; }

        .main-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        /* 1. Skill Selection */
        .col-left { flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 10px; }
        
        .skill-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .skill-card:hover { border-color: var(--accent-gold); background-color: #222; }
        .skill-card.selected { border-left: 4px solid var(--accent-gold); background-color: #252525; }
        .skill-name { font-weight: bold; color: var(--text-value); }
        .tag-fire { color: var(--accent-fire); font-weight: bold; font-size: 0.8rem; }
        .tag-ice { color: var(--accent-ice); font-weight: bold; font-size: 0.8rem; }
        .tag-lightning { color: var(--accent-lightning); font-weight: bold; font-size: 0.8rem; }

        /* 2. Configuration Panel (Middle) */
        .col-center { flex: 2; min-width: 300px; background-color: var(--panel-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 4px; }

        .section-header { 
            color: var(--accent-gold); font-size: 0.95rem; text-transform: uppercase; margin-bottom: 15px; 
            border-bottom: 1px solid #333; padding-bottom: 5px; display: flex; justify-content: space-between;
        }

        /* Input Forms */
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .input-item { display: flex; flex-direction: column; gap: 5px; }
        .input-label { font-size: 0.8rem; color: var(--text-muted); }
        .input-field { 
            background: var(--input-bg); border: 1px solid #444; color: #fff; padding: 8px; border-radius: 3px; 
            font-size: 0.95rem; width: 100%; transition: border 0.2s;
        }
        .input-field:focus { outline: none; border-color: var(--accent-gold); }

        /* Support Gems Grid */
        .support-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
        .support-gem {
            background: #000; border: 1px solid #333; padding: 10px; border-radius: 3px; cursor: pointer; text-align: center;
            font-size: 0.8rem; color: #888; transition: all 0.2s;
        }
        .support-gem:hover { border-color: #666; }
        .support-gem.active {
            border-color: var(--accent-gold); color: var(--accent-gold); background: rgba(200, 170, 109, 0.05);
        }

        /* 3. Results Panel (Right) */
        .col-right { flex: 1.5; min-width: 280px; display: flex; flex-direction: column; gap: 15px; }

        .stats-card { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 4px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .stat-label { color: #888; }
        .stat-val { color: #fff; font-weight: bold; }
        .stat-sub { font-size: 0.75rem; color: #555; }

        .highlight-dps { color: var(--accent-gold); font-size: 1.4rem; }
        .highlight-dot { color: var(--accent-fire); font-size: 1.1rem; }
        
        /* Math breakdown tooltip style */
        .formula-preview { font-family: monospace; font-size: 0.75rem; color: #555; margin-top: 5px; word-break: break-all; }

    </style>
</head>
<body>

    <h1>PoE2 Build Simulator</h1>
    <span class="version-tag">v3.0 Equipment Integration</span>

    <div class="main-container">
        
        <div class="col-left" id="skillList">
            </div>

        <div class="col-center">
            
            <div class="section-header">
                <span>Equipment Stats (Additive)</span>
                <span style="font-size:0.7rem; color:#666;">GEAR MODIFIERS</span>
            </div>
            
            <div class="input-group">
                <div class="input-item">
                    <label class="input-label">% Inc. Spell Damage</label>
                    <input type="number" id="in_incDmg" class="input-field" value="0" min="0" step="5">
                </div>
                <div class="input-item">
                    <label class="input-label">% Inc. Cast Speed</label>
                    <input type="number" id="in_incSpeed" class="input-field" value="0" min="0" step="1">
                </div>
                <div class="input-item">
                    <label class="input-label">+ Flat Added Damage</label>
                    <input type="number" id="in_flatDmg" class="input-field" value="0" min="0" step="10">
                </div>
            </div>

            <div class="section-header">
                <span>Support Gems (Multiplicative)</span>
                <span style="font-size:0.7rem; color:#666;">MORE MULTIPLIERS</span>
            </div>
            <div class="support-grid" id="supportGrid">
                </div>

        </div>

        <div class="col-right">
            <div class="stats-card">
                <div class="section-header">Final Calculation</div>
                
                <div class="stat-row">
                    <span class="stat-label">Total Hit Damage</span>
                    <span class="stat-val" id="out_hitDmg">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cast Rate</span>
                    <div>
                        <span class="stat-val" id="out_castRate">0.00</span>
                        <span class="stat-sub"> / sec</span>
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mana Cost</span>
                    <span class="stat-val" id="out_mana">0</span>
                </div>

                <div style="margin-top:20px; border-top: 1px solid #333; padding-top:10px;">
                    <span class="stat-label">Estimated Hit DPS</span>
                    <div class="highlight-dps" id="out_dps">0</div>
                    <div class="formula-preview" id="out_formula"></div>
                </div>

                <div id="dotSection" style="margin-top:15px; border-top: 1px dotted #333; padding-top:10px; display:none;">
                    <span class="stat-label">Ailment DoT (Ignite)</span>
                    <div class="highlight-dot" id="out_dot">0</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Data ---
        const skills = [
            { id: 'meteor', name: "Meteor", element: "Fire", baseDmg: 1250, castTime: 1.20, mana: 45, ailment: 0.9, tagClass: 'tag-fire' },
            { id: 'comet', name: "Comet", element: "Cold", baseDmg: 850, castTime: 0.90, mana: 35, ailment: 0, tagClass: 'tag-ice' },
            { id: 'spark', name: "Spark", element: "Lightning", baseDmg: 280, castTime: 0.65, mana: 18, ailment: 0, tagClass: 'tag-lightning' }
        ];

        const supports = [
            { id: 'faster', name: "Faster Casting", moreDmg: 1.0, moreSpeed: 1.40, manaMult: 1.2 },
            { id: 'conc', name: "Conc. Effect", moreDmg: 1.35, moreSpeed: 1.0, manaMult: 1.4 },
            { id: 'control', name: "Controlled Dest.", moreDmg: 1.25, moreSpeed: 1.0, manaMult: 1.3 },
            { id: 'deadly', name: "Deadly Ailments", moreDmg: 0.20, moreSpeed: 1.0, manaMult: 1.0, dotMore: 1.45 } // dotMore is specific
        ];

        // --- State ---
        let state = {
            skill: skills[0],
            supports: new Set(),
            incDmg: 0,
            incSpeed: 0,
            flatDmg: 0
        };

        // --- Init ---
        const skillListEl = document.getElementById('skillList');
        const supportGridEl = document.getElementById('supportGrid');
        
        // Input Els
        const inIncDmg = document.getElementById('in_incDmg');
        const inIncSpeed = document.getElementById('in_incSpeed');
        const inFlatDmg = document.getElementById('in_flatDmg');

        function init() {
            // Render Skills
            skills.forEach(s => {
                const el = document.createElement('div');
                el.className = `skill-card ${state.skill.id === s.id ? 'selected' : ''}`;
                el.innerHTML = `<span class="skill-name">${s.name}</span><span class="${s.tagClass}">${s.element}</span>`;
                el.onclick = () => {
                    state.skill = s;
                    updateUI();
                };
                skillListEl.appendChild(el);
            });

            // Render Supports
            supports.forEach(s => {
                const el = document.createElement('div');
                el.className = 'support-gem';
                el.dataset.id = s.id;
                el.innerText = s.name;
                el.onclick = () => {
                    if(state.supports.has(s.id)) state.supports.delete(s.id);
                    else state.supports.add(s.id);
                    updateUI();
                };
                supportGridEl.appendChild(el);
            });

            // Bind Inputs
            [inIncDmg, inIncSpeed, inFlatDmg].forEach(input => {
                input.addEventListener('input', (e) => {
                    state[e.target.id.replace('in_', '')] = parseFloat(e.target.value) || 0;
                    calc();
                });
            });

            updateUI();
        }

        function updateUI() {
            // Update Skill Selection Visuals
            Array.from(skillListEl.children).forEach((el, idx) => {
                const skill = skills[idx];
                el.className = `skill-card ${state.skill.id === skill.id ? 'selected' : ''}`;
            });

            // Update Support Visuals
            Array.from(supportGridEl.children).forEach(el => {
                const id = el.dataset.id;
                el.className = `support-gem ${state.supports.has(id) ? 'active' : ''}`;
            });

            // Toggle DoT Section
            document.getElementById('dotSection').style.display = state.skill.ailment > 0 ? 'block' : 'none';

            calc();
        }

        function calc() {
            const s = state.skill;
            
            // 1. Base Stats (Gem + Flat Gear)
            const baseDmgTotal = s.baseDmg + state.flatDmg;

            // 2. Additive Modifiers (Gear %)
            // Formula: Value * (1 + sum_increased / 100)
            const incDmgMult = 1 + (state.incDmg / 100);
            const incSpeedMult = 1 + (state.incSpeed / 100);

            // 3. Multiplicative Modifiers (Supports)
            let moreDmg = 1.0;
            let moreSpeed = 1.0;
            let manaMult = 1.0;
            let dotMore = 1.0;

            state.supports.forEach(supId => {
                const sup = supports.find(x => x.id === supId);
                if(sup) {
                    moreDmg *= sup.moreDmg;
                    moreSpeed *= sup.moreSpeed;
                    manaMult *= sup.manaMult;
                    if(sup.dotMore) dotMore *= sup.dotMore;
                    else dotMore *= sup.moreDmg; // Usually generic dmg supports affect DoT too unless specified
                }
            });

            // --- Final Calculations ---
            
            // Hit Damage = (Base + Flat) * Inc% * More%
            const finalHit = Math.floor(baseDmgTotal * incDmgMult * moreDmg);
            
            // Cast Rate = (1 / BaseTime) * IncSpeed% * MoreSpeed%
            // Note: In PoE, Cast Time = Base / (Inc * More). Here represented as Rate (Casts per sec).
            const baseRate = 1 / s.castTime;
            const finalRate = baseRate * incSpeedMult * moreSpeedMult;
            
            const finalMana = Math.floor(s.mana * manaMult);
            const dps = Math.floor(finalHit * finalRate);

            // DoT Calc (Ignite)
            // Ignite Base = (BaseHit * 0.9). Note: Flat dmg applies.
            // Ignite scales with generic Dmg % and Dot Multipliers, but NOT Cast Speed.
            let finalDoT = 0;
            if(s.ailment > 0) {
                const baseIgnite = baseDmgTotal * s.ailment;
                finalDoT = Math.floor(baseIgnite * incDmgMult * dotMore); // Simplified rule
            }

            // --- Render ---
            document.getElementById('out_hitDmg').innerText = finalHit.toLocaleString();
            document.getElementById('out_castRate').innerText = finalRate.toFixed(2);
            document.getElementById('out_mana').innerText = finalMana;
            document.getElementById('out_dps').innerText = dps.toLocaleString();
            document.getElementById('out_dot').innerText = finalDoT.toLocaleString() + " / sec";

            // Preview Formula for Nerds
            document.getElementById('out_formula').innerText = 
                `Formula: (${baseDmgTotal} base) x (${incDmgMult.toFixed(2)} inc) x (${moreDmg.toFixed(2)} more)`;
        }

        init();
    </script>
</body>
</html>